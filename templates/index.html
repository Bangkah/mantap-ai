<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mantap AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-3px); opacity: 1; }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
        }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }
        
        .typing-dot {
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        .glass-effect {
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .message-content pre {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .message-content code {
            background: #f1f5f9;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
        }
        
        .elegant-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .elegant-shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    
    <!-- Header -->
    <div class="glass-effect sticky top-0 z-20 border-b border-gray-200/60">
        <div class="max-w-4xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center elegant-shadow animate-pulse-glow">
                        <span class="text-white text-lg font-bold">M</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold gradient-text">Mantap AI</h1>
                        <p class="text-xs text-gray-500 mt-0.5">Intelligent Assistant</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-white/60 rounded-full border border-gray-200/60">
                        <div class="w-2 h-2 rounded-full animate-pulse" id="statusDot"></div>
                        <span class="text-sm font-medium text-gray-700" id="statusText">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="max-w-4xl mx-auto min-h-screen">
        
        <!-- Welcome Message -->
        <div id="welcomeMessage" class="px-6 py-12 text-center animate-slide-up">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-6 elegant-shadow">
                <span class="text-3xl">‚ú®</span>
            </div>
            <h2 class="text-2xl font-semibold text-gray-800 mb-3">Selamat datang di Mantap AI</h2>
            <p class="text-gray-600 max-w-lg mx-auto leading-relaxed mb-6">
                Saya adalah asisten AI yang siap membantu Anda menyelesaikan berbagai tugas dengan cerdas dan efisien. 
                Mari mulai percakapan yang produktif!
            </p>
            <div class="flex flex-wrap justify-center gap-2 text-sm text-gray-500">
                <span class="px-3 py-1 bg-white rounded-full border border-gray-200">üí¨ Chat Bahasa Indonesia & English</span>
                <span class="px-3 py-1 bg-white rounded-full border border-gray-200">üßÆ Kalkulator Built-in</span>
                <span class="px-3 py-1 bg-white rounded-full border border-gray-200">‚ö° Response Cepat</span>
            </div>
        </div>

        <!-- Messages Container -->
        <div id="chatMessages" class="px-6 pb-40">
            <!-- Messages will be inserted here -->
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="hidden px-6 mb-8 animate-fade-in">
            <div class="flex items-start gap-4">
                <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0 elegant-shadow">
                    <span class="text-white text-sm font-bold">M</span>
                </div>
                <div class="flex items-center gap-3 bg-white rounded-2xl px-4 py-3 border border-gray-200 elegant-shadow">
                    <span class="text-sm text-gray-600 font-medium">Sedang mengetik</span>
                    <div class="flex gap-1">
                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Container -->
    <div class="fixed bottom-0 left-0 right-0 glass-effect border-t border-gray-200/60">
        <div class="max-w-4xl mx-auto p-6">
            <div class="bg-white rounded-2xl elegant-shadow-lg border border-gray-200/60">
                <div class="flex items-end gap-3 p-4">
                    <div class="flex-1 relative">
                        <textarea
                            id="messageInput"
                            placeholder="Tulis pesan Anda di sini..."
                            class="w-full min-h-[48px] max-h-32 px-0 py-2 bg-transparent border-none resize-none outline-none text-gray-800 placeholder-gray-400 text-sm leading-relaxed"
                            rows="1"
                        ></textarea>
                    </div>
                    <button
                        id="sendButton"
                        onclick="sendMessage()"
                        class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed rounded-xl flex items-center justify-center text-white transition-all duration-200 elegant-shadow hover:elegant-shadow-lg disabled:shadow-none"
                        disabled
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Info Bar -->
                <div class="flex items-center justify-between px-4 pb-3 border-t border-gray-100 pt-3 text-xs">
                    <div class="flex items-center gap-4 text-gray-500">
                        <span id="modelInfo">Model: Loading...</span>
                        <span id="sessionInfo"></span>
                    </div>
                    <div class="flex items-center gap-2 text-gray-400">
                        <kbd class="px-2 py-1 bg-gray-100 rounded text-xs font-medium">‚èé</kbd>
                        <span>untuk kirim</span>
                    </div>
                </div>
            </div>
            
            <!-- Copyright -->
            <div class="text-center mt-4">
                <p class="text-xs text-gray-400">
                    ¬© 2025 <span class="font-medium text-gray-500">Muhammad Dhiyaul Atha</span> ‚Ä¢ Mantap AI
                </p>
            </div>
        </div>
    </div>

    <script>
        let isConnected = false;
        let currentModel = '';
        let sessionId = '';

        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                isConnected = data.ollama_connected;
                updateStatus(isConnected);
                
                if (isConnected) {
                    await loadModels();
                }
                
                return isConnected;
            } catch (error) {
                console.error('Health check failed:', error);
                updateStatus(false);
                return false;
            }
        }

        async function loadModels() {
            try {
                const response = await fetch('/models');
                const data = await response.json();
                currentModel = data.default || 'Unknown';
                document.getElementById('modelInfo').textContent = `Model: ${currentModel}`;
            } catch (error) {
                console.error('Failed to load models:', error);
                document.getElementById('modelInfo').textContent = 'Model: Error loading';
            }
        }

        function updateStatus(connected) {
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            
            if (connected) {
                statusText.textContent = 'Online';
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
            } else {
                statusText.textContent = 'Offline';
                statusDot.className = 'w-2 h-2 bg-red-500 rounded-full';
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message || sendButton.disabled) return;

            if (!isConnected) {
                showError('Layanan AI tidak tersedia saat ini. Silakan coba lagi nanti.');
                return;
            }

            hideWelcomeMessage();
            addMessage(message, 'user');
            input.value = '';
            adjustTextareaHeight(input);
            updateSendButton();
            
            showTypingIndicator();

            try {
                const formData = new FormData();
                formData.append('prompt', message);

                const response = await fetch('/chat', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Terjadi kesalahan pada server');
                }

                const data = await response.json();
                
                hideTypingIndicator();
                addMessage(data.reply, 'ai');

                if (data.session_id) {
                    sessionId = data.session_id;
                    document.getElementById('sessionInfo').textContent = `Session: ${sessionId}`;
                }

                if (data.model) {
                    document.getElementById('modelInfo').textContent = `Model: ${data.model}`;
                }

            } catch (error) {
                console.error('Send message error:', error);
                hideTypingIndicator();
                showError(error.message || 'Terjadi kesalahan. Silakan coba lagi.');
            } finally {
                input.focus();
            }
        }

        function hideWelcomeMessage() {
            const welcomeMsg = document.getElementById('welcomeMessage');
            if (welcomeMsg) {
                welcomeMsg.style.display = 'none';
            }
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-8 animate-fade-in`;
            
            const timestamp = new Date().toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex items-start gap-4 justify-end">
                        <div class="flex flex-col items-end max-w-[75%] lg:max-w-[60%]">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl rounded-br-md px-5 py-3 elegant-shadow">
                                <div class="text-sm leading-relaxed whitespace-pre-wrap">${escapeHtml(text)}</div>
                            </div>
                            <span class="text-xs text-gray-400 mt-2">${timestamp}</span>
                        </div>
                        <div class="w-9 h-9 bg-gradient-to-br from-gray-200 to-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-gray-700 text-sm font-medium">U</span>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0 elegant-shadow">
                            <span class="text-white text-sm font-bold">M</span>
                        </div>
                        <div class="flex flex-col max-w-[75%] lg:max-w-[80%]">
                            <div class="bg-white border border-gray-200 rounded-2xl rounded-bl-md px-5 py-4 elegant-shadow">
                                <div class="text-sm leading-relaxed message-content">${formatMessage(text)}</div>
                            </div>
                            <span class="text-xs text-gray-400 mt-2">${timestamp}</span>
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function formatMessage(text) {
            text = escapeHtml(text);
            
            // Format code blocks
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            // Format inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Format bold text
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Format italic text
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            return text;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('hidden');
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('hidden');
        }

        function showError(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mb-6 mx-auto max-w-md';
            errorDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 text-red-700 rounded-xl px-4 py-3 text-sm text-center animate-fade-in elegant-shadow">
                    <div class="flex items-center justify-center gap-2 mb-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <strong>Error</strong>
                    </div>
                    ${message}
                </div>
            `;
            messagesContainer.appendChild(errorDiv);
            scrollToBottom();
            
            setTimeout(() => {
                errorDiv.remove();
            }, 6000);
        }

        function scrollToBottom() {
            setTimeout(() => {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 128);
            textarea.style.height = newHeight + 'px';
        }

        function updateSendButton() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = !input.value.trim();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('messageInput');
            
            input.addEventListener('keydown', handleKeyPress);
            input.addEventListener('input', function() {
                adjustTextareaHeight(this);
                updateSendButton();
            });

            checkHealth();
            setInterval(checkHealth, 30000);

            input.focus();
        });
    </script>
</body>
</html>